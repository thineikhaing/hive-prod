%script{:src => "//maps.google.com/maps/api/js?v=3.13&sensor=false&libraries=geometry", :type => "text/javascript"}
%script{:src => "//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js", :type => "text/javascript"}
%script{:src => "//google-maps-utility-library-v3.googlecode.com/svn/tags/infobox/1.1.9/src/infobox_packed.js", :type => "text/javascript"}

-#%div{style:"margin-left:80px"}
-#  = image_tag("CarMask.png",alt: "CarMask",style: 'width:30px;' )
-#  = image_tag("CarMask.png",alt: "CarMask",style: 'width:30px;background:red;' )
-#  = image_tag("CarMask.png",alt: "CarMask",style: 'width:30px;background:green' )
-#  = image_tag("CarMask.png",alt: "CarMask",style: 'width:30px;background:orange' )
-#  = image_tag("CarMask.png",alt: "CarMask",style: 'width:30px;background:blue' )

%div.carmic_map
  #map


:javascript
   var __markers;
   var handler = Gmaps.build('Google', { builders: { Marker: InfoBoxBuilder} });
     handler.buildMap({ internal: {id: 'map'}}, function(){
       var markers = handler.addMarkers(#{raw @hash.to_json});
       __markers = markers
       _.each(markers, function(marker){
          google.maps.event.trigger(marker.getServiceObject(), 'click');
       });
       handler.bounds.extendWith(markers);


       handler.fitMapToBounds();
       handler.getMap().setZoom(16);
     });

      var counter = 0;

      function getCoords(){


        $.ajax({
          type: 'GET',
          url: "#{@url}",
          success: function(data){
          console.log(data.marker)

          updateMarkers(handler,data.marker,__markers);

          $(data.marker).each(function(i,e){
            console.log(e)
            var marker = e;
            var lat = e["lat"];
            var lng = e["lng"];



            //var counter = 0;
            //interval = window.setInterval(function() {
            //  counter++;
            //  // just pretend you were doing a real calculation of
            //  // new position along the complex path
            //  var pos = new google.maps.LatLng(lat,lng);
            //  handler.addMarkers(e);
            //  if (counter >= 1000) {
            //    window.clearInterval(interval);
            //  }
            //}, 10);
          })

          //Gmaps.map.replaceMarkers('');

           //var markers = handler.addMarkers(data.marker);
           //
           //// handler.removeMarkers(markers);
           //
           //
           //
           // handler.bounds.extendWith(markers);
           //
           // _.each(markers, function(marker){
           //   google.maps.event.trigger(marker.getServiceObject(), 'click');
           // });

            //handler.fitMapToBounds();
          }
        });   /*

        $.ajax({
          success: function(html) {
          console.log("call carmic")
          console.log('#{raw @hash.to_json}');

          var markers = handler.addMarkers(#{raw @hash.to_json});
                handler.bounds.extendWith(markers);
                handler.fitMapToBounds();

          }
        }); */

      }


      window.setInterval(getCoords, 5000);
