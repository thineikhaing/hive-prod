%script{src: "//maps.google.com/maps/api/js?v=3.13&sensor=false&libraries=geometry", type: "text/javascript"}
%script{src: "//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js", type: "text/javascript"}
%script{src: "//google-maps-utility-library-v3.googlecode.com/svn/tags/infobox/1.1.9/src/infobox_packed.js", type: "text/javascript"}
%script{src: "https://google-maps-utility-library-v3.googlecode.com/svn-history/r293/trunk/richmarker/src/richmarker.js", type: "text/javascript" }

%div.carmic_map
  #map

:javascript

   var __markers;
   var handler = Gmaps.build('Google', { builders: { Marker: InfoBoxBuilder} });
     handler.buildMap({ internal: {id: 'map'}}, function(){
        handler.getMap().setZoom(16);
       var markers = handler.addMarkers(#{raw @hash.to_json});
       __markers = markers

       var style = document.createElement('style');
       style.markers = [];
       document.getElementsByTagName('head')[0].appendChild(style);


       _.each(markers, function(marker){
          google.maps.event.trigger(marker.getServiceObject(), 'click');
          var icon = marker.serviceObject.getIcon();
          console.log(icon["url"])

       });

       handler.bounds.extendWith(markers);

       handler.fitMapToBounds();
       handler.getMap().setZoom(16);

     });

  function getCoords(){
    $.ajax({
      type: 'GET',
      url: "#{@url}",
      success: function(data){
      console.log(data.marker)

      updateMarkers(handler,data.marker,__markers);

      $(data.marker).each(function(i,e){
        //console.log(e)
        var marker = e;
        var lat = e["lat"];
        var lng = e["lng"];
      })

      }
    });
  }
  window.setInterval(getCoords, 5000);
