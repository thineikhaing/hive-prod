%script{:src => "//maps.google.com/maps/api/js?v=3.13&sensor=false&libraries=geometry", :type => "text/javascript"}
%script{:src => "//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js", :type => "text/javascript"}
%script{:src => "//google-maps-utility-library-v3.googlecode.com/svn/tags/infobox/1.1.9/src/infobox_packed.js", :type => "text/javascript"}

%div{style:"margin-left:80px"}
  = image_tag("CarMask.png",alt: "CarMask",style: 'width:30px;' )
  = image_tag("CarMask.png",alt: "CarMask",style: 'width:30px;background:red;' )
  = image_tag("CarMask.png",alt: "CarMask",style: 'width:30px;background:green' )
  = image_tag("CarMask.png",alt: "CarMask",style: 'width:30px;background:orange' )
  = image_tag("CarMask.png",alt: "CarMask",style: 'width:30px;background:blue' )

%div.carmic_map
  #map


:javascript
   //Carmic.init();

   //setInterval(function() {
   //    //call $.ajax here
   //
   //
   //    console.log("it's me")
   //}, 5000); //5 seconds


          //if(navigator.geolocation)
               //    navigator.geolocation.getCurrentPosition(displayOnMap);


      //function displayOnMap(position){
      //  var marker = handler.addMarker({
      //    lat: position.coords.latitude,
      //    lng: position.coords.longitude
      //  });
      //  //handler.map.centerOn(marker);
      //
      //  handler.bounds.extendWith(marker);
      //  handler.fitMapToBounds();
      //};

     /*
      var map;
      var path;
      var marker;

      function initialize() {
          var myLatlng = new google.maps.LatLng(1.317907, 103.843643);
          var myOptions = {
              zoom: 15,
              center: myLatlng
          }

          map = new google.maps.Map(document.getElementById("map"), myOptions);

          marker = new google.maps.Marker({
              position: new google.maps.LatLng(1.317907,103.843643),
              map: map
          });

          counter = 0;
          interval = window.setInterval(function () {
              counter++;
              var pos = new google.maps.LatLng(1.317907,103.843643 + counter / 100000);
              marker.setPosition(pos);
              if (counter >= 1000) {
                  window.clearInterval(interval);
              }
          }, 10);
      }


      google.maps.event.addDomListener(window, 'load', initialize);
      */

      var markersArray = [];
      handler = Gmaps.build('Google');


      handler.buildMap({ provider: {zoom: 16}, internal: {id: 'map'}}, function(){

        var markers = handler.addMarkers(#{raw @hash.to_json});

        markersArray.push(markers);

          _.each(markers, function(marker){
            google.maps.event.trigger(marker.getServiceObject(), 'click');

          });

        handler.fitMapToBounds();
        handler.getMap().setZoom(16);

        });

        //$(window).load(function(){
        //
        //  $(".hook").each(function() {
        //    $(this).parent().parent().parent().parent().siblings().addClass("info_box");
        //    //$(this).parent().parent().parent().addClass("info_box");
        //  });
        //
        //  $(".info_box").each(function() {
        //    $(this).children().addClass("sibling");
        //
        //    //$(this).parent().parent().parent().addClass("info_box");
        //  });
        //
        //  $(".sibling").each(function(){
        //     $("this :nth-child(0)").addClass("something");
        //  })
        //
        //})



      function getCoords(){

        $.ajax({
          type: 'GET',
          url: "#{@url}",
          success: function(data){
          console.log(data.marker)
          console.log("previous markers")
          console.log(Gmaps.map)

          Gmaps.map

          //Gmaps.map.replaceMarkers('');

           //var markers = handler.addMarkers(data.marker);
           //
           //// handler.removeMarkers(markers);
           //
           //
           //
           // handler.bounds.extendWith(markers);
           //
           // _.each(markers, function(marker){
           //   google.maps.event.trigger(marker.getServiceObject(), 'click');
           // });


            console.log("replace marker")

            //handler.fitMapToBounds();
          }
        });   /*

        $.ajax({
          success: function(html) {
          console.log("call carmic")
          console.log('#{raw @hash.to_json}');

          var markers = handler.addMarkers(#{raw @hash.to_json});
                handler.bounds.extendWith(markers);
                handler.fitMapToBounds();

          }
        }); */

      }


      //window.setInterval(getCoords, 5000);
